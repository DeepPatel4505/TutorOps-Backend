# ğŸ” TutorOps Backend - Authentication Flow & Complete Summary

**Project:** TutorOps AI Tutoring Platform  
**Version:** 1.0.0  
**Last Updated:** December 3, 2025  
**Tech Stack:** Node.js 18+, Express 5, PostgreSQL, Redis, Prisma ORM

---

## ğŸ“‹ Table of Contents

1. [Backend Architecture Overview](#backend-architecture)
2. [Complete Authentication Flow](#authentication-flow)
3. [API Endpoints](#api-endpoints)
4. [Database Schema](#database-schema)
5. [Security Features](#security-features)
6. [Tech Stack & Dependencies](#tech-stack)

---

## ğŸ—ï¸ Backend Architecture Overview

### **Project Structure**

```
backend/
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma              # Database models & relations
â”‚   â””â”€â”€ migrations/                # Version-controlled migrations
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js                   # Server entry point
â”‚   â”œâ”€â”€ app.js                     # Express app configuration
â”‚   â”‚
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ env.js                 # Environment variables
â”‚   â”‚
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ router.js              # Main router (mounts /auth, /system)
â”‚   â”‚   â””â”€â”€ socket.js              # WebSocket config
â”‚   â”‚
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ auth/                  # Authentication module
â”‚   â”‚   â”‚   â”œâ”€â”€ router.js          # Auth routes
â”‚   â”‚   â”‚   â”œâ”€â”€ controllers/       # HTTP handlers
â”‚   â”‚   â”‚   â”œâ”€â”€ services/          # Business logic
â”‚   â”‚   â”‚   â”œâ”€â”€ daos/              # Data access layer
â”‚   â”‚   â”‚   â””â”€â”€ dtos/              # Validation schemas
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ system/                # Health checks
â”‚   â”‚
â”‚   â”œâ”€â”€ middlewares/
â”‚   â”‚   â”œâ”€â”€ isAuthenticated.js     # Auth guard
â”‚   â”‚   â”œâ”€â”€ errorHandler.js        # Global error handler
â”‚   â”‚   â””â”€â”€ zodValidator.js        # Request validator
â”‚   â”‚
â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”œâ”€â”€ ApiError.js            # Custom error class
â”‚   â”‚   â””â”€â”€ ApiResponse.js         # Standard response format
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ prisma.js              # Prisma client
â”‚   â”‚   â”œâ”€â”€ redis.js               # Redis client & session store
â”‚   â”‚   â”œâ”€â”€ googleOAuth.js         # Google OAuth helpers
â”‚   â”‚   â”œâ”€â”€ logger.js              # Pino logger
â”‚   â”‚   â””â”€â”€ constant.js            # App constants
â”‚   â”‚
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ aiEngine/              # AI services
â”‚   â”‚   â””â”€â”€ mathEngine/            # Math problem generation
â”‚   â”‚
â”‚   â””â”€â”€ generated/
â”‚       â””â”€â”€ prisma/                # Auto-generated Prisma client
â”‚
â””â”€â”€ package.json
```

### **Architecture Pattern: 3-Tier MVC**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Controller  â”‚  â† HTTP Request/Response handling
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Service    â”‚  â† Business logic, validation
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     DAO      â”‚  â† Database/Redis operations
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Complete Authentication Flow

### **Overview**

The authentication system uses **session-based authentication** with Redis storage, supporting:

- âœ… Email/Password registration & login
- âœ… Google OAuth 2.0
- âœ… Multi-device session tracking
- âœ… Secure logout (single & all devices)
- âœ… CSRF protection
- âœ… Password hashing (bcrypt)

---

### **1ï¸âƒ£ Registration Flow**

**Endpoint:** `POST /api/auth/register`  
**Request Body:**

```json
{
    "email": "student@example.com",
    "password": "SecurePass123",
    "username": "john_doe",
    "role": 0 // 0=STUDENT, 1=TEACHER, 2=ADMIN
}
```

**Flow Diagram:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. CLIENT REQUEST                                               â”‚
â”‚    POST /api/auth/register                                      â”‚
â”‚    Headers: { _csrf: "token" }                                  â”‚
â”‚    Body: { email, password, username, role }                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. MIDDLEWARE STACK (app.js)                                    â”‚
â”‚    âœ“ CORS validation (localhost:5173 + 172.20.64.1:5000)       â”‚
â”‚    âœ“ JSON body parsing                                          â”‚
â”‚    âœ“ Cookie parsing                                             â”‚
â”‚    âœ“ Request/Response logging (Pino)                            â”‚
â”‚    âœ“ Session middleware (loads session from Redis)             â”‚
â”‚    âœ“ CSRF token validation                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ROUTING                                                       â”‚
â”‚    core/router.js â†’ /api/auth â†’ auth/router.js                 â”‚
â”‚    auth/router.js â†’ POST /register â†’ registerController        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. CONTROLLER (register.controller.js)                          â”‚
â”‚    â€¢ Extract { email, password, username, role }                â”‚
â”‚    â€¢ Call registerService()                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. SERVICE (register.service.js)                                â”‚
â”‚    Step 1: Check if email exists                                â”‚
â”‚            findUserByEmail(email) â†’ Prisma query                â”‚
â”‚            If exists â†’ throw ApiError.badRequest(400)           â”‚
â”‚                                                                  â”‚
â”‚    Step 2: Hash password                                        â”‚
â”‚            salt = bcrypt.genSalt(10)                            â”‚
â”‚            hashedPassword = bcrypt.hash(password, salt)         â”‚
â”‚                                                                  â”‚
â”‚    Step 3: Convert role                                         â”‚
â”‚            ROLE[0] â†’ "STUDENT"                                  â”‚
â”‚            ROLE[1] â†’ "TEACHER"                                  â”‚
â”‚            ROLE[2] â†’ "ADMIN"                                    â”‚
â”‚                                                                  â”‚
â”‚    Step 4: Create user in database                              â”‚
â”‚            createUser(prisma, {email, hashedPassword, ...})     â”‚
â”‚                                                                  â”‚
â”‚    Step 5: Return user data                                     â”‚
â”‚            return { id, role, email, username }                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. DAO (user.dao.js)                                            â”‚
â”‚    createUser():                                                â”‚
â”‚      â€¢ Normalize email to lowercase                             â”‚
â”‚      â€¢ Prisma: user.create({                                    â”‚
â”‚          data: {                                                â”‚
â”‚            email: email.toLowerCase(),                          â”‚
â”‚            password: hashedPassword,                            â”‚
â”‚            username,                                            â”‚
â”‚            name: username,                                      â”‚
â”‚            role: "STUDENT"                                      â”‚
â”‚          }                                                      â”‚
â”‚        })                                                       â”‚
â”‚      â€¢ Returns new user object with generated ID (cuid)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. SESSION CREATION (back in controller)                        â”‚
â”‚    Step 1: Regenerate session (prevents session fixation)      â”‚
â”‚            req.session.regenerate()                             â”‚
â”‚                                                                  â”‚
â”‚    Step 2: Store user in session                                â”‚
â”‚            req.session.user = { id, role }                      â”‚
â”‚                                                                  â”‚
â”‚    Step 3: Get session ID                                       â”‚
â”‚            sessionID = req.sessionID (auto-generated UUID)      â”‚
â”‚                                                                  â”‚
â”‚    Step 4: Track session in Redis                               â”‚
â”‚            addSessionForUser(userId, sessionID)                 â”‚
â”‚            Redis: SADD user_sessions:{userId} sessionID         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. RESPONSE                                                      â”‚
â”‚    Status: 201 Created                                          â”‚
â”‚    Headers:                                                      â”‚
â”‚      Set-Cookie: tutorops_session={sessionID};                  â”‚
â”‚                  HttpOnly; SameSite=Lax; Max-Age=604800         â”‚
â”‚    Body:                                                         â”‚
â”‚      {                                                           â”‚
â”‚        "data": {                                                â”‚
â”‚          "userData": {                                          â”‚
â”‚            "id": "cm4abc123xyz",                                â”‚
â”‚            "email": "student@example.com",                      â”‚
â”‚            "username": "john_doe",                              â”‚
â”‚            "role": "STUDENT"                                    â”‚
â”‚          }                                                      â”‚
â”‚        },                                                       â”‚
â”‚        "message": "Registration successful"                     â”‚
â”‚      }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Database State After Registration:**

```
PostgreSQL (User table):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id           â”‚ email                 â”‚ username â”‚ role    â”‚ password     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cm4abc123xyz â”‚ student@example.com   â”‚ john_doe â”‚ STUDENT â”‚ $2a$10$...  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Redis:
tutorops:sess:{sessionID} â†’ { "user": { "id": "cm4abc123xyz", "role": "STUDENT" } }
user_sessions:cm4abc123xyz â†’ ["sess:abc123..."]
```

---

### **2ï¸âƒ£ Login Flow**

**Endpoint:** `POST /api/auth/login`  
**Request Body:**

```json
{
    "email": "student@example.com",
    "password": "SecurePass123"
}
```

**Flow Diagram:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. CLIENT REQUEST                                               â”‚
â”‚    POST /api/auth/login                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. MIDDLEWARE STACK (same as registration)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. CONTROLLER (login.controller.js)                             â”‚
â”‚    â€¢ Extract { email, password }                                â”‚
â”‚    â€¢ Call loginService()                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. SERVICE (login.service.js)                                   â”‚
â”‚    Step 1: Find user by email                                   â”‚
â”‚            user = findUserByEmail(email)                        â”‚
â”‚            If !user â†’ throw ApiError(400, "Invalid email/pass") â”‚
â”‚                                                                  â”‚
â”‚    Step 2: Verify password                                      â”‚
â”‚            valid = verifyUserPassword(user, password)           â”‚
â”‚            Uses: bcrypt.compare(password, user.password)        â”‚
â”‚            If !valid â†’ throw ApiError(400, "Invalid email/pass")â”‚
â”‚                                                                  â”‚
â”‚    Step 3: Return user payload                                  â”‚
â”‚            return { id, role, email, username }                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. SESSION CREATION (back in controller)                        â”‚
â”‚    Step 1: Regenerate session (security: new session ID)       â”‚
â”‚    Step 2: req.session.user = { id, role }                     â”‚
â”‚    Step 3: Track in Redis: addSessionForUser(userId, sessionID)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. RESPONSE                                                      â”‚
â”‚    Status: 200 OK                                               â”‚
â”‚    Cookie: tutorops_session (7-day expiry)                      â”‚
â”‚    Body: { data: { user }, message: "Login successful" }       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Security Notes:**

- Session regeneration prevents **session fixation attacks**
- Generic error messages prevent **user enumeration**
- Bcrypt comparison is **timing-safe**

---

### **3ï¸âƒ£ Get Current User (Me)**

**Endpoint:** `GET /api/auth/me`  
**Protected:** âœ… Yes (requires authentication)

**Flow Diagram:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. CLIENT REQUEST                                               â”‚
â”‚    GET /api/auth/me                                             â”‚
â”‚    Cookie: tutorops_session={sessionID}                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. SESSION MIDDLEWARE (app.js)                                  â”‚
â”‚    â€¢ Read cookie: tutorops_session                              â”‚
â”‚    â€¢ Query Redis: GET tutorops:sess:{sessionID}                 â”‚
â”‚    â€¢ Deserialize: req.session = { user: { id, role } }         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. isAuthenticated MIDDLEWARE                                   â”‚
â”‚    Check 1: req.session exists? âœ“                               â”‚
â”‚    Check 2: req.session.user exists? âœ“                          â”‚
â”‚    Check 3: req.session.user.id exists? âœ“                       â”‚
â”‚                                                                  â”‚
â”‚    If ANY check fails:                                          â”‚
â”‚      â†’ return ApiError(401, "Unauthorized : Not logged in")     â”‚
â”‚                                                                  â”‚
â”‚    If all pass:                                                 â”‚
â”‚      â†’ next()                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. CONTROLLER (getme.controller.js)                             â”‚
â”‚    â€¢ userId = req.session.user.id (guaranteed by middleware)    â”‚
â”‚    â€¢ Call getMe(req, res)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. SERVICE (getMe.service.js)                                   â”‚
â”‚    â€¢ user = findUserById(req.session.user.id)                   â”‚
â”‚    â€¢ Return { user }                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. DAO (user.dao.js)                                            â”‚
â”‚    findUserById():                                              â”‚
â”‚      Prisma: user.findUnique({                                  â”‚
â”‚        where: { id },                                           â”‚
â”‚        select: { id, email, name, username, role }              â”‚
â”‚      })                                                         â”‚
â”‚      Note: password field is excluded                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. RESPONSE                                                      â”‚
â”‚    Status: 200 OK                                               â”‚
â”‚    Body: {                                                       â”‚
â”‚      "user": {                                                  â”‚
â”‚        "id": "cm4abc123xyz",                                    â”‚
â”‚        "email": "student@example.com",                          â”‚
â”‚        "name": "john_doe",                                      â”‚
â”‚        "username": "john_doe",                                  â”‚
â”‚        "role": "STUDENT"                                        â”‚
â”‚      }                                                          â”‚
â”‚    }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **4ï¸âƒ£ Logout (Single Device)**

**Endpoint:** `POST /api/auth/logout`

**Flow Diagram:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. CLIENT REQUEST                                               â”‚
â”‚    POST /api/auth/logout                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. CONTROLLER (logout.controller.js)                            â”‚
â”‚    Step 1: Get session info                                     â”‚
â”‚            userId = req.session?.user?.id                       â”‚
â”‚            sessionId = req.sessionID                            â”‚
â”‚                                                                  â”‚
â”‚    Step 2: Remove from tracking (if exists)                     â”‚
â”‚            if (userId && sessionId):                            â”‚
â”‚              logoutService(userId, sessionId)                   â”‚
â”‚              â†’ Redis: SREM user_sessions:{userId} sessionId     â”‚
â”‚                                                                  â”‚
â”‚    Step 3: Destroy session                                      â”‚
â”‚            req.session.destroy()                                â”‚
â”‚            â†’ Redis: DEL tutorops:sess:{sessionID}               â”‚
â”‚                                                                  â”‚
â”‚    Step 4: Clear cookie                                         â”‚
â”‚            res.clearCookie('tutorops_session')                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. RESPONSE                                                      â”‚
â”‚    Status: 200 OK                                               â”‚
â”‚    Body: { message: "Logged out successfully" }                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **5ï¸âƒ£ Logout All Devices**

**Endpoint:** `POST /api/auth/logoutAllDevices`  
**Protected:** âœ… Yes (requires authentication)

**Flow Diagram:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. CLIENT REQUEST                                               â”‚
â”‚    POST /api/auth/logoutAllDevices                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. isAuthenticated MIDDLEWARE                                   â”‚
â”‚    Validates session exists                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. CONTROLLER (logoutAllDevicesController)                      â”‚
â”‚    Step 1: userId = req.session.user.id (guaranteed)            â”‚
â”‚                                                                  â”‚
â”‚    Step 2: Call logoutAllDevicesService(userId)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. SERVICE (logoutAllDevicesService)                            â”‚
â”‚    Step 1: Get all session IDs for user                         â”‚
â”‚            sessions = getSessionsForUser(userId)                â”‚
â”‚            Redis: SMEMBERS user_sessions:{userId}               â”‚
â”‚            Returns: ["sess:abc", "sess:def", "sess:ghi"]        â”‚
â”‚                                                                  â”‚
â”‚    Step 2: Destroy each session in Redis store                  â”‚
â”‚            For each sessionId:                                  â”‚
â”‚              store.destroy(sessionId)                           â”‚
â”‚              Redis: DEL tutorops:sess:{sessionId}               â”‚
â”‚                                                                  â”‚
â”‚    Step 3: Clear tracking set                                   â”‚
â”‚            removeAllSessionsForUser(userId)                     â”‚
â”‚            Redis Pipeline: SREM user_sessions:{userId} (all)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. BACK TO CONTROLLER                                           â”‚
â”‚    Step 1: Destroy current session too                          â”‚
â”‚            req.session.destroy()                                â”‚
â”‚                                                                  â”‚
â”‚    Step 2: Clear cookie                                         â”‚
â”‚            res.clearCookie('tutorops_session')                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. RESPONSE                                                      â”‚
â”‚    Status: 200 OK                                               â”‚
â”‚    Body: { message: "Logged out from all devices successfully" }â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Effect:**

- All active sessions destroyed across all devices
- User must login again everywhere
- Useful for security incidents or password changes

---

### **6ï¸âƒ£ Google OAuth Flow**

**Endpoint:** `POST /api/auth/googleCallback`

**Flow Diagram:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. USER INTERACTION                                             â”‚
â”‚    â€¢ User clicks "Sign in with Google" on frontend              â”‚
â”‚    â€¢ Frontend redirects to Google OAuth consent screen          â”‚
â”‚    â€¢ User approves permissions                                  â”‚
â”‚    â€¢ Google redirects to: {BACKEND_URL}/auth/google-callback    â”‚
â”‚      Query params: ?code=AUTH_CODE&state={"from":"/dashboard"}  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. CONTROLLER (googleCallback.controller.js)                    â”‚
â”‚    Step 1: Extract & parse params                               â”‚
â”‚            code = req.query.code                                â”‚
â”‚            state = JSON.parse(decodeURIComponent(req.query.state))â”‚
â”‚            If !code â†’ redirect to FRONTEND_URL                  â”‚
â”‚                                                                  â”‚
â”‚    Step 2: Authenticate with Google                             â”‚
â”‚            googleUser = authenticateGoogleLogin(code)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. SERVICE (googleAuth.service.js)                              â”‚
â”‚    authenticateGoogleLogin(code):                               â”‚
â”‚      Call getGoogleUserFromCode(code)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. OAUTH UTILITY (googleOAuth.js)                               â”‚
â”‚    getGoogleUserFromCode(code):                                 â”‚
â”‚                                                                  â”‚
â”‚    Step 1: Exchange code for tokens                             â”‚
â”‚            exchangeCodeForTokens(code)                          â”‚
â”‚            POST https://oauth2.googleapis.com/token             â”‚
â”‚            Body: {                                              â”‚
â”‚              client_id: GOOGLE_CLIENT_ID,                       â”‚
â”‚              client_secret: GOOGLE_CLIENT_SECRET,               â”‚
â”‚              code: code,                                        â”‚
â”‚              grant_type: "authorization_code",                  â”‚
â”‚              redirect_uri: "{BACKEND_URL}/auth/google-callback" â”‚
â”‚            }                                                    â”‚
â”‚            Response: { access_token, id_token }                 â”‚
â”‚                                                                  â”‚
â”‚    Step 2: Get user info                                        â”‚
â”‚            getGoogleUserInfo(access_token)                      â”‚
â”‚            GET https://googleapis.com/oauth2/v1/userinfo        â”‚
â”‚            Headers: { Authorization: "Bearer {access_token}" }  â”‚
â”‚            Response: { id, email, name, picture }               â”‚
â”‚                                                                  â”‚
â”‚    Return: { googleUser, tokens }                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. BACK TO CONTROLLER                                           â”‚
â”‚    Step 3: Find or create user                                  â”‚
â”‚            user = googleLoginService(googleUser)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. SERVICE (googleAuth.service.js)                              â”‚
â”‚    googleLoginService(googleUser):                              â”‚
â”‚                                                                  â”‚
â”‚    Step 1: Try to find existing user                            â”‚
â”‚            user = findUserByEmail(googleUser.email)             â”‚
â”‚                                                                  â”‚
â”‚    Step 2: If not found, create new user                        â”‚
â”‚            if (!user):                                          â”‚
â”‚              user = createGoogleUser(googleUser)                â”‚
â”‚              Prisma: user.create({                              â”‚
â”‚                email: googleUser.email.toLowerCase(),           â”‚
â”‚                name: googleUser.name,                           â”‚
â”‚                googleId: googleUser.id,                         â”‚
â”‚                password: null,  â† No password for OAuth users   â”‚
â”‚                role: "STUDENT"  â† Default role                  â”‚
â”‚              })                                                 â”‚
â”‚                                                                  â”‚
â”‚    Step 3: Return user                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. BACK TO CONTROLLER - SESSION CREATION                        â”‚
â”‚    Step 1: Regenerate session                                   â”‚
â”‚            req.session.regenerate()                             â”‚
â”‚                                                                  â”‚
â”‚    Step 2: Store user in session                                â”‚
â”‚            req.session.user = { id: user.id, role: user.role }  â”‚
â”‚                                                                  â”‚
â”‚    Step 3: Track session                                        â”‚
â”‚            addSessionForUser(user.id, req.sessionID)            â”‚
â”‚                                                                  â”‚
â”‚    Step 4: Redirect to frontend                                 â”‚
â”‚            res.redirect(`${FRONTEND_URL}${state.from || '/'}`)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. USER REDIRECTED TO FRONTEND                                  â”‚
â”‚    â€¢ Session cookie automatically sent                          â”‚
â”‚    â€¢ User is authenticated                                      â”‚
â”‚    â€¢ Lands on requested page (e.g., /dashboard)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¡ API Endpoints

### **Authentication Endpoints**

| Method | Endpoint                     | Protected | Description                        |
| ------ | ---------------------------- | --------- | ---------------------------------- |
| POST   | `/api/auth/register`         | âŒ        | Register new user (email/password) |
| POST   | `/api/auth/login`            | âŒ        | Login with credentials             |
| POST   | `/api/auth/logout`           | âŒ        | Logout current device              |
| POST   | `/api/auth/logoutAllDevices` | âœ…        | Logout all devices                 |
| POST   | `/api/auth/googleCallback`   | âŒ        | Google OAuth callback handler      |
| GET    | `/api/auth/me`               | âœ…        | Get current user info              |
| GET    | `/api/auth/csrf-token`       | âŒ        | Get CSRF token for forms           |

### **System Endpoints**

| Method | Endpoint             | Protected | Description              |
| ------ | -------------------- | --------- | ------------------------ |
| GET    | `/api/system/health` | âŒ        | Health check (DB, Redis) |
| GET    | `/test`              | âŒ        | Basic handshake test     |

---

## ğŸ—„ï¸ Database Schema

### **User Model**

```prisma
model User {
  id        String   @id @default(cuid())
  name      String
  username  String?  @unique
  email     String   @unique
  password  String?              // Nullable for OAuth users
  googleId  String?  @unique     // For Google OAuth
  role      Role                 // STUDENT | TEACHER | ADMIN
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  classesTaught   Class[]         // Teacher â†’ Classes
  enrollments     Enrollment[]    // Student â†’ Classes
  problemsCreated Problem[]       // Creator â†’ Problems
  attempts        Attempt[]       // Student â†’ Attempts
  Report          Report[]        // Student â†’ Reports

  @@index([email])
  @@index([username])
}

enum Role {
  STUDENT
  TEACHER
  ADMIN
}
```

### **Core Models**

- **Class:** Teacher-created classes
- **Enrollment:** Student enrollment in classes
- **Assignment:** Class assignments
- **Problem:** Template problems (reusable)
- **ProblemInstance:** Specific problem instances with parameters
- **Attempt:** Student problem solutions
- **Report:** Student performance reports

### **Entity Relationships**

```
User (Teacher) â”€â”€â”€â”€â”€< Class
                       â”‚
User (Student) â”€â”€â”€â”€â”€< Enrollment >â”€â”€â”€â”€â”€ Class
                       â”‚
User (Student) â”€â”€â”€â”€â”€< Attempt >â”€â”€â”€â”€â”€ ProblemInstance â”€â”€â”€â”€â”€< Assignment
                       â”‚                                      â”‚
User (Student) â”€â”€â”€â”€â”€< Report >â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Assignment
                       â”‚
User (Creator) â”€â”€â”€â”€â”€< Problem â”€â”€â”€â”€â”€â”€â”€< ProblemInstance
```

---

## ğŸ”’ Security Features

### **1. Session Security**

```javascript
{
  store: RedisStore,              // Fast, scalable storage
  name: 'tutorops_session',
  secret: SESSION_SECRET,         // From env variable
  resave: false,
  saveUninitialized: false,
  rolling: true,                  // Extend expiry on activity
  cookie: {
    httpOnly: true,               // Prevents XSS attacks
    secure: NODE_ENV === 'production',  // HTTPS only in prod
    sameSite: 'lax',              // CSRF protection
    maxAge: 7 * 24 * 60 * 60 * 1000  // 7 days
  }
}
```

**Session Regeneration:**

- After login â†’ Prevents session fixation
- After registration â†’ Prevents session fixation
- After OAuth â†’ Prevents session fixation

### **2. Password Security**

- **Hashing:** bcrypt with 10 salt rounds
- **Comparison:** Timing-safe bcrypt.compare()
- **Storage:** Never returned in API responses
- **Validation:** Minimum complexity (enforced client-side)

### **3. CSRF Protection**

```javascript
app.use(csurf());  // After sessions

// Token exposed at:
GET /api/auth/csrf-token â†’ { csrfToken: "..." }

// Frontend includes token in:
// - Form: <input name="_csrf" value={token} />
// - Header: X-CSRF-Token: {token}
```

### **4. CORS Configuration**

```javascript
cors({
    origin: [
        process.env.FRONTEND_URL, // Main frontend
        'http://172.20.64.1:5000', // Additional allowed origin
    ],
    credentials: true, // Allow cookies
});
```

### **5. Error Handling**

```javascript
// ApiError class with helper methods
ApiError.badRequest(400)      // Client errors
ApiError.unauthorized(401)     // Auth failures
ApiError.forbidden(403)        // Permission denied
ApiError.notFound(404)         // Resource not found
ApiError.internal(500)         // Server errors

// Global error handler:
â€¢ Masks Prisma errors in production
â€¢ Filters stack traces (only src/ files)
â€¢ Logs selectively (skips 400/401/403/404)
â€¢ Returns clean JSON responses
```

### **6. Input Validation**

- **DTOs:** Zod schemas for request validation
- **Email normalization:** Lowercase conversion
- **SQL injection:** Protected by Prisma ORM (parameterized queries)

### **7. Logging**

```javascript
// Pino logger with:
â€¢ Request/Response logging
â€¢ Error logging with clean stack traces
â€¢ Redaction: ['req.headers.authorization', 'password']
â€¢ Environment-based formatting:
  - Dev: pino-pretty (colored, formatted)
  - Prod: JSON to file (./logs/app.log)
```

---

## ğŸ› ï¸ Tech Stack & Dependencies

### **Core Technologies**

- **Runtime:** Node.js 18+
- **Framework:** Express 5.1.0
- **Database:** PostgreSQL (via Prisma)
- **Cache/Sessions:** Redis (ioredis)
- **ORM:** Prisma 7.0.1

### **Authentication**

- **bcryptjs** 3.0.2 - Password hashing
- **express-session** 1.18.2 - Session management
- **connect-redis** 6.1.3 - Redis session store
- **csurf** 1.11.0 - CSRF protection
- **cookie-parser** 1.4.7 - Cookie handling
- **axios** 1.12.2 - HTTP client (Google OAuth)

### **Security & Validation**

- **cors** 2.8.5 - Cross-origin requests
- **zod** 4.1.11 - Schema validation
- **express-rate-limit** 8.2.1 - Rate limiting

### **Logging**

- **pino** 9.11.0 - Fast JSON logger
- **pino-pretty** 13.1.2 - Dev-friendly output

### **Development**

- **nodemon** 3.1.10 - Auto-restart
- **tsx** 4.20.6 - TypeScript execution
- **prettier** 3.5.3 - Code formatting

---

## ğŸš€ Server Startup Sequence

```
1. index.js entry point
   â†“
2. Import app.js (triggers all imports)
   â†“
3. Load environment variables (env.js) - FIRST
   â†“
4. Initialize Redis client (redis.js)
   â€¢ Connect to REDIS_URL
   â€¢ Setup event handlers (connect, error, reconnecting)
   â€¢ Max reconnection attempts: 5
   â†“
5. Initialize Prisma client (prisma.js)
   â€¢ Connect to DATABASE_URL (PostgreSQL)
   â€¢ Load generated Prisma Client
   â†“
6. Configure Express app (app.js)
   â€¢ CORS â†’ JSON parsing â†’ Cookies â†’ Logging
   â€¢ Redis session store
   â€¢ CSRF protection
   â€¢ Mount routes: /api â†’ appRouter
   â€¢ Global error handler
   â†“
7. Create HTTP server (index.js)
   â€¢ Listen on PORT (default: 3000)
   â€¢ Log: "Server running on port {PORT} in {NODE_ENV} mode"
   â†“
8. Register process event handlers
   â€¢ unhandledRejection â†’ log & continue
   â€¢ uncaughtException â†’ log & exit(1)
   â€¢ RedisNotConnected â†’ log & exit(1)
   â€¢ SIGINT/SIGTERM â†’ graceful shutdown (5s timeout)
   â†“
9. Server ready to accept requests âœ“
```

---

## ğŸ“Š Redis Data Structures

### **Session Data** (managed by express-session)

```
Key: tutorops:sess:{sessionID}
Value: {
  "user": {
    "id": "cm4abc123xyz",
    "role": "STUDENT"
  },
  "cookie": {
    "originalMaxAge": 604800000,
    "expires": "2025-12-10T12:00:00.000Z",
    "httpOnly": true,
    "path": "/"
  }
}
TTL: 7 days (auto-renewed on activity if rolling: true)
```

### **Session Tracking** (managed by session.dao.js)

```
Key: user_sessions:{userId}
Type: Set
Members: ["sess:abc123...", "sess:def456...", "sess:ghi789..."]
Purpose: Track all active sessions per user for multi-device logout
```

---

## ğŸ¯ Current Features Summary

### âœ… **Implemented**

1. **User Authentication**
    - Email/Password registration
    - Email/Password login
    - Google OAuth 2.0 integration
    - Session-based auth with Redis
    - Multi-device session tracking

2. **Session Management**
    - 7-day rolling sessions
    - Single device logout
    - All devices logout
    - Automatic session renewal

3. **Security**
    - CSRF protection
    - CORS configuration
    - Password hashing (bcrypt)
    - Session fixation prevention
    - HttpOnly cookies
    - Structured error handling

4. **User Management**
    - Role-based access (STUDENT, TEACHER, ADMIN)
    - User profile retrieval
    - Email uniqueness validation
    - Google account linking

5. **Infrastructure**
    - PostgreSQL database (Prisma ORM)
    - Redis caching & sessions
    - Structured logging (Pino)
    - Health check endpoint
    - Graceful shutdown handling

### ğŸ”œ **Planned Features** (based on schema)

- Class management (teachers create classes)
- Student enrollment system
- Assignment creation & distribution
- Math problem generation (AI-powered)
- Student attempt tracking
- Auto-grading system
- Performance reports
- Real-time features (Socket.IO)

---

## ğŸ“ Environment Variables Required

```env
# Server
NODE_ENV=development
PORT=3000

# URLs
FRONTEND_URL=http://localhost:5173
BACKEND_URL=http://localhost:3000

# Database
DATABASE_URL=postgresql://user:password@localhost:5432/tutorops

# Redis
REDIS_URL=redis://localhost:6379

# Session
SESSION_SECRET=your-super-secret-key-change-in-production

# Google OAuth
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# AI (future)
AI_API_KEY=your-ai-api-key
```

---

## ğŸ“ˆ Request/Response Flow Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    CLIENT    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP Request (with cookies)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EXPRESS MIDDLEWARE STACK                    â”‚
â”‚  1. CORS validation                          â”‚
â”‚  2. Body parsing (JSON, URL-encoded)         â”‚
â”‚  3. Cookie parsing                           â”‚
â”‚  4. Request logging                          â”‚
â”‚  5. Session loading (from Redis)             â”‚
â”‚  6. CSRF validation                          â”‚
â”‚  7. Route matching                           â”‚
â”‚  8. isAuthenticated (if protected)           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CONTROLLER (HTTP Layer)                     â”‚
â”‚  â€¢ Extract request data                      â”‚
â”‚  â€¢ Call service layer                        â”‚
â”‚  â€¢ Handle session operations                 â”‚
â”‚  â€¢ Format response                           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SERVICE (Business Logic)                    â”‚
â”‚  â€¢ Validate business rules                   â”‚
â”‚  â€¢ Process data                              â”‚
â”‚  â€¢ Call DAO layer                            â”‚
â”‚  â€¢ Return results                            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DAO (Data Access)                           â”‚
â”‚  â€¢ Prisma queries (PostgreSQL)               â”‚
â”‚  â€¢ Redis operations (sessions, cache)        â”‚
â”‚  â€¢ Return raw data                           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DATABASE / REDIS                            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ (Response flows back up the stack)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RESPONSE MIDDLEWARE                         â”‚
â”‚  â€¢ Response logging                          â”‚
â”‚  â€¢ Error handling (if error occurred)        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    CLIENT    â”‚  â† JSON response + Set-Cookie header
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Summary

Your **TutorOps Backend** is a production-ready, secure authentication system built with modern best practices:

- âœ… **Scalable Architecture:** 3-tier MVC pattern with clear separation of concerns
- âœ… **Enterprise Security:** Session regeneration, CSRF protection, password hashing, HttpOnly cookies
- âœ… **Multi-Auth Support:** Email/password + Google OAuth 2.0
- âœ… **Session Management:** Redis-backed sessions with multi-device tracking
- âœ… **Error Handling:** Structured error responses with detailed logging
- âœ… **Type Safety:** Prisma ORM with generated TypeScript types
- âœ… **Observability:** Structured logging with Pino (dev & prod modes)
- âœ… **Database Design:** Well-structured schema ready for educational platform features

The foundation is solid for building out the remaining features (classes, assignments, AI grading, etc.). ğŸš€
